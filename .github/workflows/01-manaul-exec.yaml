name: 'ExecuÃ§Ã£o manual'

on:
  workflow_dispatch:

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: latest  

      - name: 'InstalaÃ§Ã£o do Yarn'
        run: npm install -g yarn  

      - name: 'InstalaÃ§Ã£o das dependÃªncias'
        run: yarn  

      - name: 'InstalaÃ§Ã£o do Playwright'
        run: yarn playwright install  

      - name: 'Executando testes E2E com Playwright'
        run: yarn run e2e

      - name: Compactar relatÃ³rio do Playwright
        run: zip -r playwright-report.zip playwright-report

      # NotificaÃ§Ã£o de sucesso
      - name: Notificar Discord (sucesso)
        if: success()
        uses: appleboy/discord-action@v1.2.0
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          message: |
            ðŸŽ‰ **Sucesso na execuÃ§Ã£o dos testes 
            Projeto: **${{ github.repository }}**  
            Branch: `${{ github.ref_name }}`  
            ðŸ“„ [Ver detalhes](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      # NotificaÃ§Ã£o de falha
      - name: Notificar Discord (falha)
        if: failure()
        uses: appleboy/discord-action@v1.2.0
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          message: |
            **Falha na execuÃ§Ã£o do pipeline!**  
            Projeto: **${{ github.repository }}**  
            Branch: `${{ github.ref_name }}`  
            ðŸ“„ [Ver detalhes](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      # Envio de relatÃ³rio por e-mail
      - name: Enviar relatÃ³rio por e-mail
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "âœ… RelatÃ³rio de Testes - ${{ github.repository }}"
          to: seuemail@exemplo.com
          from: Natalia QA <${{ secrets.MAIL_USERNAME }}>
          body: |
            OlÃ¡, time QA ðŸ‘‹  
            Segue em anexo o relatÃ³rio de testes gerado automaticamente pelo GitHub Actions.

            âœ… ExecuÃ§Ã£o: ${{ github.run_number }}  
            ðŸ”— [Ver detalhes no GitHub](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          attachments: playwright-report.zip
          convert_markdown: true
