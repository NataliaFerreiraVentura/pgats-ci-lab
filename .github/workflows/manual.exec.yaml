name: 'Execu√ß√£o manual Windows self-hosted runner'

on:
  workflow_dispatch:

jobs:
  e2e-tests:
    runs-on: self-hosted  # assume Windows self-hosted runner

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 'latest'

      - name: 'Instala√ß√£o do Yarn'
        run: npm install -g yarn

      - name: 'Instala√ß√£o das depend√™ncias'
        run: yarn

      - name: 'Instala√ß√£o do Playwright'
        run: yarn playwright install

      - name: 'Executando testes E2E com Playwright'
        run: yarn run e2e

      - name: 'Listar arquivos do relat√≥rio'
        shell: powershell
        run: Get-ChildItem -Force playwright-report | Format-List

      - name: 'Compactar relat√≥rio do Playwright'
        shell: powershell
        run: Compress-Archive -Path playwright-report\* -DestinationPath playwright-report.zip

      - name: 'Notificar Discord (sucesso)'
        if: success()
        shell: powershell
        run: |
          $webhookUrl = '${{ secrets.DISCORD_WEBHOOK_URL }}'
          $body = @{
            content = "üéâ **Sucesso na execu√ß√£o dos testes!**`nProjeto: **${{ github.repository }}**`nBranch: ${{ github.ref_name }} `nüìÑ [Ver detalhes](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } | ConvertTo-Json
          Invoke-RestMethod -Uri $webhookUrl -Method POST -Body $body -ContentType 'application/json'

      - name: 'Notificar Discord (falha)'
        if: failure()
        shell: powershell
        run: |
          $webhookUrl = '${{ secrets.DISCORD_WEBHOOK_URL }}'
          $body = @{
            content = "‚ùå **Falha na execu√ß√£o do pipeline!**`nProjeto: **${{ github.repository }}**`nBranch: ${{ github.ref_name }} `nüìÑ [Ver detalhes](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } | ConvertTo-Json
          Invoke-RestMethod -Uri $webhookUrl -Method POST -Body $body -ContentType 'application/json'