name: 'ExecuÃ§Ã£o manual Windows self-hosted runner'

on:
  workflow_dispatch:

jobs:
  e2e-tests:
    runs-on: self-hosted  # assume Windows self-hosted runner

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 'latest'

      - name: 'InstalaÃ§Ã£o do Yarn'
        run: npm install -g yarn

      - name: 'InstalaÃ§Ã£o das dependÃªncias'
        run: yarn

      - name: 'InstalaÃ§Ã£o do Playwright'
        run: yarn playwright install

      - name: 'Executando testes E2E com Playwright'
        run: yarn run e2e

      - name: 'Listar arquivos do relatÃ³rio'
        shell: powershell
        run: Get-ChildItem -Force playwright-report | Format-List

      - name: 'Compactar relatÃ³rio do Playwright'
        shell: powershell
        run: Compress-Archive -Path playwright-report\* -DestinationPath playwright-report.zip

      - name: 'Notificar Discord (sucesso)'
        if: success()
        shell: powershell
        env:
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          RUN_ID: ${{ github.run_id }}
          SERVER_URL: ${{ github.server_url }}
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          [Console]::OutputEncoding = [Text.UTF8Encoding]::new()

          $webhookUrl = $env:WEBHOOK_URL
          $message = "ðŸŽ‰ **Sucesso na execuÃ§Ã£o dos testes!**`n" +
                     "Projeto: **$env:REPO**`n" +
                     "Branch: $env:BRANCH`n" +
                     "ðŸ“„ [Ver detalhes]($env:SERVER_URL/$env:REPO/actions/runs/$env:RUN_ID)"

          $bodyJson = @{ content = $message } | ConvertTo-Json -Compress
          $bytes = [System.Text.Encoding]::UTF8.GetBytes($bodyJson)

          Invoke-RestMethod -Uri $webhookUrl -Method POST -Body $bytes -ContentType 'application/json; charset=utf-8'
